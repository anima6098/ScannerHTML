<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Code 128 Scanner (with Beep)</title>
  <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 30px auto;
      max-width: 700px;
    }
    #interactive {
      width: 100%;
      max-width: 500px;
      margin: auto;
      position: relative;
    }
    video, canvas {
      width: 100%;
    }
    #status {
      font-size: 18px;
      font-weight: bold;
      color: blue;
      margin-top: 10px;
    }
    #result {
      margin-top: 10px;
      font-size: 20px;
      color: green;
    }
    #log {
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      background: #f8f8f8;
      text-align: left;
      padding: 10px;
      font-family: monospace;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <h2>ðŸ“¦ Code 128 Barcode Scanner</h2>
  <p id="status">ðŸ”„ Ready to scan...</p>
  <div id="interactive" class="viewport"></div>
  <p id="result">No scan yet</p>

  <h3>ðŸ“œ Scan Log</h3>
  <div id="log">No scans yet.</div>

  <!-- Beep sound -->
  <audio id="beep-sound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>

  <script>
    const resultEl = document.getElementById('result');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const beep = document.getElementById('beep-sound');
    let lastCode = '';

    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector('#interactive'),
        constraints: {
          width: 640,
          height: 480,
          facingMode: "environment"
        }
      },
      locator: {
        patchSize: "medium",
        halfSample: true
      },
      numOfWorkers: 2,
      decoder: {
        readers: ["code_128_reader"]
      },
      locate: true,
      frequency: 10
    }, function(err) {
      if (err) {
        console.error(err);
        statusEl.textContent = 'âŒ Failed to start scanner.';
        return;
      }
      Quagga.start();
      console.log("Quagga started");
    });

    Quagga.onDetected(async function(data) {
      const code = data.codeResult.code;
      if (code && code !== lastCode) {
        lastCode = code;
        resultEl.textContent = 'âœ… Scanned: ' + code;
        statusEl.textContent = 'â¸ Paused...';

        try {
          await navigator.clipboard.writeText(code);
        } catch (err) {
          console.error('Clipboard error:', err);
        }

        // Log
        const time = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.textContent = `[${time}] ${code}`;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;

        // Beep
        beep.currentTime = 0;
        beep.play();

        // Pause briefly to avoid duplicate scans
        Quagga.pause();
        setTimeout(() => {
          resultEl.textContent = 'No scan yet';
          statusEl.textContent = 'ðŸ”„ Ready to scan...';
          lastCode = '';
          Quagga.start();
        }, 1000);
      }
    });
  </script>
</body>
</html>
