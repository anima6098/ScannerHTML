<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Code 128 Scanner (Preprocessed)</title>
  <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 30px auto;
      max-width: 700px;
    }
    #interactive {
      width: 100%;
      max-width: 500px;
      margin: auto;
      position: relative;
    }
    canvas, video {
      width: 100%;
    }
    #result {
      margin-top: 15px;
      font-size: 18px;
      color: green;
    }
    #log {
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      background: #f8f8f8;
      text-align: left;
      padding: 10px;
      font-family: monospace;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>ðŸ“¦ Code 128 Barcode Scanner</h2>
  <div id="interactive" class="viewport"></div>
  <p id="result">Waiting for scan...</p>

  <h3>ðŸ“œ Scan Log</h3>
  <div id="log">No scans yet.</div>

  <script>
    const resultEl = document.getElementById('result');
    const logEl = document.getElementById('log');
    let lastCode = '';

    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector('#interactive'),
        constraints: {
          width: 640,
          height: 480,
          facingMode: "environment"
        }
      },
      locator: {
        patchSize: "medium",
        halfSample: true
      },
      numOfWorkers: 2,
      decoder: {
        readers: ["code_128_reader"]
      },
      locate: true,
      frequency: 10, // FPS for scan attempts
    }, function(err) {
      if (err) {
        console.error(err);
        return;
      }
      Quagga.start();
      console.log("Quagga started");
    });

    Quagga.onProcessed(function(result) {
      // Optional: visualize processing (grayscale, boxes, etc.)
    });

    Quagga.onDetected(async function(data) {
      const code = data.codeResult.code;
      if (code && code !== lastCode) {
        lastCode = code;
        resultEl.textContent = 'âœ… Scanned: ' + code;

        try {
          await navigator.clipboard.writeText(code);
        } catch (err) {
          console.error('Clipboard error:', err);
        }

        const time = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.textContent = `[${time}] ${code}`;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;

        // Debounce scanning for 1s to avoid duplicates
        Quagga.pause();
        setTimeout(() => {
          resultEl.textContent = 'ðŸ”„ Ready for next scan';
          lastCode = '';
          Quagga.start();
        }, 1000);
      }
    });
  </script>
</body>
</html>
